# 二十、多生产者-多消费者问题

## 问题描述
桌子上有一个盘子，每次只能向其中放入一个水果。爸爸专向盘子放入苹果，妈妈专门放入橘子，儿子专等着吃盘子中的橘子，女儿专等着吃盘子中的苹果。只有盘子为空时，爸爸或妈妈才可向盘子中放入一个水果。仅当盘子中有自己需要的水果时，儿子或女儿可以从盘子中取出水果

![](%E4%BA%8C%E5%8D%81%E3%80%81%E5%A4%9A%E7%94%9F%E4%BA%A7%E8%80%85-%E5%A4%9A%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98/%E6%88%AA%E5%B1%8F2021-04-06%2013.03.13.png)
![](%E4%BA%8C%E5%8D%81%E3%80%81%E5%A4%9A%E7%94%9F%E4%BA%A7%E8%80%85-%E5%A4%9A%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98/%E6%88%AA%E5%B1%8F2021-04-06%2013.03.53.png)

> 所谓的多生产者，多消费者。其实不是指 “ 多个 ”，而是指 **多个类别**的产品  

1. 关系分析
	* 互斥关系
		对缓冲区（盘子）的访问要互斥地进行

	* 同步关系（一前一后）
		1. 父亲将苹果放入盘子后，女儿才能取苹果
		2. 母亲将橘子放入盘子后，儿子才能取橘子
		3. 只有**盘子为空**时，**父亲或母亲**才能放入水果（同时，盘子为空这个事件，即可以由儿子触发，也可以由女儿触发）

2. 整理思路
	* 实现互斥：在临界区前后分别PV
	* 实现同步：前V后P（前事件 - V操作 - P操作 - 后事件）
![](%E4%BA%8C%E5%8D%81%E3%80%81%E5%A4%9A%E7%94%9F%E4%BA%A7%E8%80%85-%E5%A4%9A%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98/%E6%88%AA%E5%B1%8F2021-04-06%2013.11.25.png)
	
3. 实现
![](%E4%BA%8C%E5%8D%81%E3%80%81%E5%A4%9A%E7%94%9F%E4%BA%A7%E8%80%85-%E5%A4%9A%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98/%E6%88%AA%E5%B1%8F2021-04-06%2013.11.38.png)

实现同步：P(plate)、V(apple)，父亲母亲放水果前，先检查盘子中是否还可以放水果，可以的话就先P操作、再放水果，然后进行V操作
![](%E4%BA%8C%E5%8D%81%E3%80%81%E5%A4%9A%E7%94%9F%E4%BA%A7%E8%80%85-%E5%A4%9A%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98/%E6%88%AA%E5%B1%8F2021-04-06%2013.16.00.png)

实现互斥：对（盘子）缓冲区的互斥访问，访问前对临界区进行P操作（加锁），访问后进行V操作（解锁）
![](%E4%BA%8C%E5%8D%81%E3%80%81%E5%A4%9A%E7%94%9F%E4%BA%A7%E8%80%85-%E5%A4%9A%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98/%E6%88%AA%E5%B1%8F2021-04-06%2013.17.04.png)

* 在此题中，即使不设置专门的互斥变量mutex，也不会出现多个进程同时访问盘子的现象

> 本题中的缓冲区大小为1，在任何时刻，apple、orange、plate三个同步信号量中最多只有一个是1。因此在任何时刻，最多只有一个进程的P操作不会被阻塞，并顺利地进入临界区。  
> 如果容量为2，则不满足  
